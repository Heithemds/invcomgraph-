<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventaire Atelier</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --card2:#0f1621;
      --text:#e7eefc;
      --muted:#9bb0d1;
      --line:#223149;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#3b82f6;
      --accent2:#06b6d4;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --r:14px;
      --pad:16px;
      --fs:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(59,130,246,.20), transparent 50%),
                  radial-gradient(900px 600px at 110% 10%, rgba(6,182,212,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
      font-size:var(--fs);
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(6,182,212,.95));
      box-shadow: var(--shadow);
    }
    .title{
      line-height:1.1;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.5px;
      text-transform: uppercase;
    }
    .title .sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--muted);
    }

    .status-pill{
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(17,24,36,.65);
      color: var(--muted);
      font-size: 12px;
      display:flex; gap:8px; align-items:center;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(17,24,36,.92), rgba(15,22,33,.92));
      border:1px solid rgba(34,49,73,.8);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 14px var(--pad);
      border-bottom: 1px solid rgba(34,49,73,.7);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(10,16,24,.35);
    }
    .card .head .h{
      font-weight: 800;
      letter-spacing: .7px;
      text-transform: uppercase;
      font-size: 13px;
    }
    .card .body{ padding: var(--pad); }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (max-width: 540px){
      .row{grid-template-columns: 1fr;}
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    input, select, textarea{
      width: 100%;
      background: rgba(9,14,20,.9);
      border: 2px solid rgba(34,49,73,.9);
      color: var(--text);
      border-radius: 12px;
      padding: 14px 12px;
      outline: none;
      font-size: 16px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(59,130,246,.9);
      box-shadow: 0 0 0 4px rgba(59,130,246,.18);
    }
    input[type="number"]{ appearance:textfield; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

    .toggle{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn-toggle{
      flex:1;
      padding: 14px 12px;
      border-radius: 12px;
      border: 2px solid rgba(34,49,73,.9);
      background: rgba(9,14,20,.9);
      color: var(--text);
      font-weight: 800;
      letter-spacing:.8px;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      min-height: 52px;
    }
    .btn-toggle.active{
      border-color: rgba(6,182,212,.95);
      box-shadow: 0 0 0 4px rgba(6,182,212,.16);
      background: linear-gradient(180deg, rgba(6,182,212,.18), rgba(9,14,20,.9));
    }

    .sizes{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 8px;
    }
    @media (max-width: 820px){
      .sizes{grid-template-columns: repeat(3, 1fr);}
    }
    .sizeBox{
      background: rgba(9,14,20,.85);
      border: 2px solid rgba(34,49,73,.85);
      border-radius: 12px;
      padding: 10px;
    }
    .sizeBox .k{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 8px;
      font-weight: 800;
    }
    .sizeBox input{
      padding: 12px 10px;
      border-radius: 10px;
      border-width: 2px;
      font-size: 18px;
      text-align: center;
      min-height: 48px;
    }

    .total{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 14px var(--pad);
      border-top: 1px solid rgba(34,49,73,.7);
      background: rgba(10,16,24,.35);
    }
    .total .big{
      font-size: 30px;
      font-weight: 900;
      letter-spacing: 1px;
    }
    .total .meta{
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .7px;
    }

    .actions{
      display:flex;
      gap: 10px;
      margin-top: 14px;
    }
    .btn{
      flex:1;
      padding: 14px 12px;
      border-radius: 14px;
      border: 2px solid rgba(34,49,73,.9);
      background: rgba(9,14,20,.9);
      color: var(--text);
      font-weight: 900;
      letter-spacing:.8px;
      text-transform: uppercase;
      cursor:pointer;
      min-height: 54px;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(6,182,212,.95));
      border-color: rgba(59,130,246,.8);
      box-shadow: 0 10px 22px rgba(59,130,246,.18);
    }
    .btn.secondary{
      background: rgba(17,24,36,.6);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.55);
      background: rgba(239,68,68,.12);
    }

    .note{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      min-width: 280px;
      max-width: 92vw;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(34,49,73,.8);
      background: rgba(17,24,36,.92);
      box-shadow: var(--shadow);
      display:none;
      gap:10px;
      align-items:flex-start;
      z-index: 9999;
    }
    .toast.show{display:flex;}
    .toast .t{font-weight:800;}
    .toast .m{color:var(--muted); font-size: 13px; margin-top:2px;}
    .toast .ico{width:12px;height:12px;border-radius:99px;margin-top:4px}
    .ico.ok{background:var(--ok)}
    .ico.bad{background:var(--bad)}
    .ico.warn{background:var(--warn)}

    .history{
      padding: 0;
      margin: 0;
      list-style:none;
    }
    .history li{
      padding: 12px var(--pad);
      border-top: 1px solid rgba(34,49,73,.55);
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }
    .history .left{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width: 0;
    }
    .history .a{
      font-weight: 900;
      letter-spacing:.4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .history .b{
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .history .right{
      text-align:right;
      flex: 0 0 auto;
    }
    .badge{
      display:inline-block;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(34,49,73,.8);
      color: var(--muted);
      background: rgba(9,14,20,.85);
      text-transform: uppercase;
      letter-spacing: .6px;
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <h1>Inventaire Textile — Atelier</h1>
          <div class="sub">Saisie rapide • Base centralisée Supabase • Table: <b>inventory</b></div>
        </div>
      </div>
      <div class="status-pill" id="netPill">
        <span class="dot" id="netDot"></span>
        <span id="netTxt">Connexion…</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Form -->
      <div class="card">
        <div class="head">
          <div class="h">Saisie Carton</div>
          <div class="badge" id="whoBadge">Non connecté</div>
        </div>
        <div class="body">
          <div class="row">
            <div>
              <label>Compte par (nom)</label>
              <select id="comptePar">
                <option value="">— Choisir —</option>
                <option>Maeva</option>
                <option>Aurélien</option>
                <option>Astrid</option>
                <option>Brenda</option>
                <option>Youri</option>
                <option value="__other__">Autre…</option>
              </select>
              <div id="otherNameWrap" style="margin-top:10px; display:none;">
                <input id="otherName" placeholder="Saisir le nom" />
              </div>
            </div>

            <div>
              <label>Carton code (unique)</label>
              <input id="cartonCode" placeholder="ex: C-001" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Désignation</label>
              <input id="designation" placeholder="ex: TSHIRT / POLO / CHEMISE" />
            </div>
            <div>
              <label>Grammage</label>
              <input id="grammage" inputmode="numeric" placeholder="ex: 190" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Référence</label>
              <input id="ref" placeholder="ex: E191" />
            </div>
            <div>
              <label>Couleur (nom long)</label>
              <input id="couleur" placeholder="ex: Dark Grey / Urban Orange" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Manches</label>
              <div class="toggle">
                <button type="button" class="btn-toggle" id="btnMC">MC</button>
                <button type="button" class="btn-toggle" id="btnML">ML</button>
              </div>
            </div>
            <div>
              <label>Remarque</label>
              <input id="remarque" placeholder="optionnel" />
            </div>
          </div>

          <div class="card" style="border-radius:14px; margin-top: 12px;">
            <div class="head">
              <div class="h">Quantités par taille</div>
              <div class="badge">Clavier numérique</div>
            </div>
            <div class="body">
              <div class="sizes" id="sizesGrid"></div>
              <div class="note">
                Astuce: tu peux laisser vide → c’est 0. Total calculé automatiquement.
              </div>
            </div>
            <div class="total">
              <div>
                <div class="meta">Total carton</div>
                <div class="big" id="totalBig">0</div>
              </div>
              <div class="badge" id="manchesBadge">MANCHES: —</div>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnSend">Valider & Envoyer</button>
            <button class="btn secondary" id="btnClear">Reset</button>
            <button class="btn danger" id="btnLogout">Changer Nom</button>
          </div>

          <div class="note">
            Données envoyées dans Supabase: <b>inventory</b>. Champ <b>compte_par</b> rempli automatiquement.
          </div>
        </div>
      </div>

      <!-- RIGHT: History -->
      <div class="card">
        <div class="head">
          <div class="h">Historique (appareil)</div>
          <div class="badge" id="histCount">0</div>
        </div>
        <ul class="history" id="historyList"></ul>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="ico" id="toastIco"></div>
    <div>
      <div class="t" id="toastTitle">Info</div>
      <div class="m" id="toastMsg">…</div>
    </div>
  </div>

  <!-- Supabase JS (CDN) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === Supabase config (TON PROJET) ===
    const SUPABASE_URL = "https://pzagcexmeqwfznxskmxu.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6YWdjZXhtZXF3ZnpueHNrbXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNjAwNzUsImV4cCI6MjA4MzgzNjA3NX0.tDwHz-sgowrbifeAZr3UItwn3Ue-B4d9wifXP4oisLY";
    const TABLE = "inventory";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === UI refs ===
    const netDot = document.getElementById("netDot");
    const netTxt = document.getElementById("netTxt");

    const comptePar = document.getElementById("comptePar");
    const otherNameWrap = document.getElementById("otherNameWrap");
    const otherName = document.getElementById("otherName");
    const whoBadge = document.getElementById("whoBadge");

    const cartonCode = document.getElementById("cartonCode");
    const designation = document.getElementById("designation");
    const grammage = document.getElementById("grammage");
    const ref = document.getElementById("ref");
    const couleur = document.getElementById("couleur");
    const remarque = document.getElementById("remarque");

    const btnMC = document.getElementById("btnMC");
    const btnML = document.getElementById("btnML");
    const manchesBadge = document.getElementById("manchesBadge");

    const sizesGrid = document.getElementById("sizesGrid");
    const totalBig = document.getElementById("totalBig");

    const btnSend = document.getElementById("btnSend");
    const btnClear = document.getElementById("btnClear");
    const btnLogout = document.getElementById("btnLogout");

    const historyList = document.getElementById("historyList");
    const histCount = document.getElementById("histCount");

    // Toast
    const toast = document.getElementById("toast");
    const toastIco = document.getElementById("toastIco");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    function showToast(type, title, msg){
      clearTimeout(toastTimer);
      toastIco.className = "ico " + (type || "warn");
      toastTitle.textContent = title || "Info";
      toastMsg.textContent = msg || "";
      toast.classList.add("show");
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 3200);
    }

    // === Network indicator ===
    function updateNet(){
      const ok = navigator.onLine;
      netDot.className = "dot " + (ok ? "ok" : "bad");
      netTxt.textContent = ok ? "En ligne" : "Hors ligne";
    }
    window.addEventListener("online", updateNet);
    window.addEventListener("offline", updateNet);
    updateNet();

    // === Sizes ===
    const SIZES = ["XS","S","M","L","XL","XXL","3XL","4XL","5XL"];
    const sizeInputs = new Map();

    function buildSizes(){
      sizesGrid.innerHTML = "";
      for(const s of SIZES){
        const box = document.createElement("div");
        box.className = "sizeBox";
        const k = document.createElement("div");
        k.className = "k";
        k.textContent = s;
        const inp = document.createElement("input");
        inp.inputMode = "numeric";
        inp.placeholder = "0";
        inp.dataset.size = s;

        inp.addEventListener("input", ()=>{
          inp.value = inp.value.replace(/[^\d]/g,""); // digits only
          computeTotal();
        });

        // auto-next on Enter
        inp.addEventListener("keydown", (e)=>{
          if(e.key === "Enter"){
            e.preventDefault();
            focusNextSize(s);
          }
        });

        box.appendChild(k);
        box.appendChild(inp);
        sizesGrid.appendChild(box);
        sizeInputs.set(s, inp);
      }
    }

    function focusNextSize(current){
      const idx = SIZES.indexOf(current);
      if(idx >= 0 && idx < SIZES.length - 1){
        sizeInputs.get(SIZES[idx+1]).focus();
        sizeInputs.get(SIZES[idx+1]).select?.();
      } else {
        btnSend.focus();
      }
    }

    function computeTotal(){
      let t = 0;
      for(const s of SIZES){
        const v = parseInt(sizeInputs.get(s).value || "0", 10);
        t += (Number.isFinite(v) ? v : 0);
      }
      totalBig.textContent = String(t);
      return t;
    }

    buildSizes();
    computeTotal();

    // === Manches toggle ===
    let manches = "";
    function setManches(v){
      manches = v;
      btnMC.classList.toggle("active", v === "MC");
      btnML.classList.toggle("active", v === "ML");
      manchesBadge.textContent = "MANCHES: " + (v || "—");
    }
    btnMC.addEventListener("click", ()=>setManches("MC"));
    btnML.addEventListener("click", ()=>setManches("ML"));

    // === Name selection ===
    const LS_USER = "inv26_user";
    const LS_HISTORY = "inv26_history";

    function getUser(){
      return localStorage.getItem(LS_USER) || "";
    }
    function setUser(name){
      localStorage.setItem(LS_USER, name);
      whoBadge.textContent = name ? ("Connecté: " + name) : "Non connecté";
    }

    function getSelectedName(){
      const v = comptePar.value;
      if(v === "__other__"){
        return (otherName.value || "").trim();
      }
      return (v || "").trim();
    }

    comptePar.addEventListener("change", ()=>{
      otherNameWrap.style.display = (comptePar.value === "__other__") ? "block" : "none";
      const nm = getSelectedName();
      if(nm){
        setUser(nm);
        showToast("ok", "Nom enregistré", nm);
      }
      updateWhoBadge();
    });

    otherName.addEventListener("input", ()=>{
      const nm = getSelectedName();
      if(nm){
        setUser(nm);
        updateWhoBadge();
      }
    });

    function updateWhoBadge(){
      const nm = getSelectedName() || getUser();
      whoBadge.textContent = nm ? ("Connecté: " + nm) : "Non connecté";
    }

    // prefill name if saved
    const saved = getUser();
    if(saved){
      // try match dropdown
      const opts = [...comptePar.options].map(o=>o.value || o.textContent);
      if(opts.includes(saved)){
        comptePar.value = saved;
      } else {
        comptePar.value = "__other__";
        otherNameWrap.style.display = "block";
        otherName.value = saved;
      }
      setUser(saved);
      updateWhoBadge();
    }

    // === Normalisation ref (I->1, O->0 dans la partie numérique) ===
    function normalizeRef(raw){
      let x = (raw || "").toUpperCase().replace(/\s+/g,"");
      if(!x) return x;
      // sépare prefix lettres / suffix
      const m = x.match(/^([A-Z]+)(.*)$/);
      if(!m) return x;
      const prefix = m[1];
      let rest = m[2] || "";
      // dans la partie "reste", convertir I->1 et O->0
      rest = rest.replace(/I/g,"1").replace(/O/g,"0");
      return prefix + rest;
    }

    // === History local ===
    function loadHistory(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_HISTORY) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveHistory(arr){
      localStorage.setItem(LS_HISTORY, JSON.stringify(arr.slice(0, 30)));
      renderHistory();
    }
    function pushHistory(item){
      const arr = loadHistory();
      arr.unshift(item);
      saveHistory(arr);
    }
    function renderHistory(){
      const arr = loadHistory();
      histCount.textContent = String(arr.length);
      historyList.innerHTML = "";
      if(arr.length === 0){
        const li = document.createElement("li");
        li.innerHTML = `<div class="left"><div class="a">Aucune saisie</div><div class="b">Les dernières saisies apparaîtront ici.</div></div><div class="right"><span class="badge">—</span></div>`;
        historyList.appendChild(li);
        return;
      }
      for(const it of arr){
        const li = document.createElement("li");
        const a = `${it.ref} • ${it.couleur} • ${it.manches}`;
        const b = `${it.compte_par} • ${it.carton_code || "—"} • ${new Date(it.created_at).toLocaleString()}`;
        li.innerHTML = `
          <div class="left">
            <div class="a">${escapeHtml(a)}</div>
            <div class="b">${escapeHtml(b)}</div>
          </div>
          <div class="right">
            <div style="font-weight:900; font-size:16px;">${it.total}</div>
            <div class="badge">Envoyé</div>
          </div>`;
        historyList.appendChild(li);
      }
    }
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    renderHistory();

    // === Reset ===
    function resetForm(keepUser=true){
      cartonCode.value = "";
      designation.value = "";
      grammage.value = "";
      ref.value = "";
      couleur.value = "";
      remarque.value = "";
      setManches("");
      for(const s of SIZES){
        sizeInputs.get(s).value = "";
      }
      computeTotal();
      if(!keepUser){
        comptePar.value = "";
        otherNameWrap.style.display = "none";
        otherName.value = "";
        localStorage.removeItem(LS_USER);
      }
      ref.focus();
    }

    btnClear.addEventListener("click", ()=>resetForm(true));
    btnLogout.addEventListener("click", ()=>{
      resetForm(false);
      updateWhoBadge();
      showToast("warn", "Nom effacé", "Choisis ton nom à nouveau.");
    });

    // === Send ===
    btnSend.addEventListener("click", async ()=>{
      const nm = getSelectedName() || getUser();
      if(!nm){
        showToast("bad", "Nom requis", "Choisis un nom (compte_par) avant de valider.");
        comptePar.focus();
        return;
      }

      const refVal = normalizeRef(ref.value);
      if(!refVal){
        showToast("bad", "Référence requise", "Champ REF obligatoire.");
        ref.focus();
        return;
      }

      const colVal = (couleur.value || "").trim();
      if(!colVal){
        showToast("bad", "Couleur requise", "Champ COULEUR obligatoire.");
        couleur.focus();
        return;
      }

      if(!manches){
        showToast("bad", "Manches requises", "Sélectionne MC ou ML.");
        btnMC.focus();
        return;
      }

      const tailles = {};
      let total = 0;
      for(const s of SIZES){
        const v = parseInt(sizeInputs.get(s).value || "0", 10);
        const q = Number.isFinite(v) ? v : 0;
        tailles[s] = q;
        total += q;
      }
      if(total <= 0){
        showToast("bad", "Quantités vides", "Saisis au moins une taille > 0.");
        sizeInputs.get("L").focus();
        return;
      }

      const g = (grammage.value || "").trim();
      const grammageInt = g ? parseInt(g.replace(/[^\d]/g,""), 10) : null;

      const payload = {
        compte_par: nm,
        carton_code: (cartonCode.value || "").trim() || null,
        designation: (designation.value || "").trim() || null,
        ref: refVal,
        grammage: Number.isFinite(grammageInt) ? grammageInt : null,
        couleur: colVal,
        manches: manches,
        tailles_json: tailles,
        total: total,
        remarque: (remarque.value || "").trim() || null,
      };

      try{
        btnSend.disabled = true;
        btnSend.textContent = "Envoi…";

        const { data, error } = await supabase
          .from(TABLE)
          .insert(payload)
          .select("id, created_at");

        if(error){
          // cas unique carton_code
          if((error.message || "").toLowerCase().includes("duplicate") || (error.code === "23505")){
            showToast("bad", "Doublon carton_code", "Ce carton_code existe déjà. Change le code.");
            cartonCode.focus();
          } else {
            showToast("bad", "Erreur Supabase", error.message || "Insertion impossible.");
          }
          return;
        }

        const created_at = data?.[0]?.created_at || new Date().toISOString();
        pushHistory({ ...payload, created_at });
        showToast("ok", "Envoyé", `${payload.ref} • Total ${payload.total} • ${payload.compte_par}`);

        // reset mais garde nom + manches
        const keepM = manches;
        resetForm(true);
        setManches(keepM);

      } finally {
        btnSend.disabled = false;
        btnSend.textContent = "Valider & Envoyer";
      }
    });

    // Prefill: focus ref
    ref.addEventListener("blur", ()=>{ ref.value = normalizeRef(ref.value); });
    ref.focus();
  </script>
</body>
</html>
