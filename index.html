create or replace view public.stock_total as
with expanded as (
  select
    ref,
    couleur,
    manches,
    e.key as taille,
    (e.value)::int as qte
  from public.inventory i
  cross join jsonb_each(i.tailles_json) as e
)
select
  ref,
  couleur,
  manches,
  taille,
  sum(qte) as qte_total
from expanded
group by ref, couleur, manches, taille
order by ref, couleur, manches, taille;
